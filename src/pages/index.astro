---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Iniciar Sesión">
	<main class="login-container">
		<div class="login-card animate-fade-in">
			<header class="login-header">
				<div class="logo-placeholder">GS</div>
				<h1>Bienvenido</h1>
				<p>Ingresa tus credenciales para acceder al portal</p>
			</header>

			<form class="login-form" id="loginForm">
				<div class="form-group">
					<label for="username">Usuario</label>
					<input
						type="text"
						id="username"
						name="username"
						placeholder="Tu usuario"
						required
					/>
				</div>

				<div class="form-group">
					<label for="password">Contraseña</label>
					<input
						type="password"
						id="password"
						name="password"
						placeholder="••••••••"
						required
					/>
				</div>

				<button type="submit" class="btn btn-primary w-full">
					Iniciar Sesión
				</button>
			</form>

			<footer class="login-footer">
				<p>Gestión de Solicitudes</p>
			</footer>
		</div>
	</main>
</Layout>

<style>
	.login-container {
		display: flex;
		align-items: center;
		justify-content: center;
		min-height: 100vh;
		background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
		padding: 1.5rem;
	}

	.login-card {
		background: white;
		padding: 2.5rem;
		border-radius: var(--radius-lg);
		box-shadow: var(--shadow-lg);
		width: 100%;
		max-width: 400px;
		border: 1px solid var(--border);
	}

	.login-header {
		text-align: center;
		margin-bottom: 2rem;
	}

	.logo-placeholder {
		width: 64px;
		height: 64px;
		background: var(--primary);
		color: white;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 800;
		font-size: 1.5rem;
		border-radius: 1rem;
		margin: 0 auto 1rem;
		box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
	}

	.login-header h1 {
		font-size: 1.875rem;
		margin-bottom: 0.5rem;
	}

	.login-header p {
		color: var(--text-muted);
		font-size: 0.875rem;
	}

	.login-form {
		display: flex;
		flex-direction: column;
		gap: 1.25rem;
	}

	.form-group {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.form-group label {
		font-size: 0.875rem;
		font-weight: 500;
		color: var(--text-main);
	}

	.w-full {
		width: 100%;
		padding: 0.75rem;
	}

	.login-footer {
		margin-top: 2rem;
		text-align: center;
		padding-top: 1.5rem;
		border-top: 1px solid var(--border);
	}

	.login-footer p {
		font-size: 0.75rem;
		color: var(--text-muted);
	}
</style>

<script>
	import { auth } from "../lib/api";

	const loginForm = document.getElementById("loginForm") as HTMLFormElement;
	const errorMsg = document.createElement("p");
	errorMsg.style.color = "#ef4444";
	errorMsg.style.fontSize = "0.875rem";
	errorMsg.style.marginTop = "1rem";
	errorMsg.style.textAlign = "center";
	loginForm?.appendChild(errorMsg);

	loginForm?.addEventListener("submit", async (e) => {
		e.preventDefault();
		errorMsg.textContent = "";

		const formData = new FormData(loginForm);
		const login = formData.get("username") as string;
		const password = formData.get("password") as string;

		const btn = loginForm.querySelector("button");
		if (btn) {
			btn.disabled = true;
			btn.textContent = "Iniciando...";
		}

		try {
			const data = await auth.login({ login, password });
			localStorage.setItem("user_id", data.id_usuario);
			localStorage.setItem("user_login", data.login);
			localStorage.setItem("user_name", data.nombre);
			localStorage.setItem("user_paterno", data.paterno);
			localStorage.setItem("user_materno", data.materno);
			window.location.href = "/dashboard";
		} catch (error: any) {
			errorMsg.textContent = error.message || "Error al iniciar sesión";
			if (btn) {
				btn.disabled = false;
				btn.textContent = "Iniciar Sesión";
			}
		}
	});
</script>

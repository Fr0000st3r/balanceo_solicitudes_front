---
import Layout from "../layouts/Layout.astro";
import Sidebar from "../components/Sidebar.astro";
import UserBadge from "../components/UserBadge.astro";
---

<Layout title="Reportes">
    <div class="app-layout">
        <Sidebar active="reportes" />

        <main class="main-content">
            <header class="page-header">
                <div class="header-title-row">
                    <div class="header-title-left">
                        <button class="mobile-menu-toggle" id="menuToggle"
                            >‚ò∞</button
                        >
                        <h1>Reportes y Estad√≠sticas</h1>
                    </div>
                    <UserBadge />
                </div>
                <p class="header-subtitle hide-mobile">
                    Carga de trabajo por usuario y exportaci√≥n de datos
                </p>
            </header>

            <div class="page-actions-row">
                <div class="flex gap-2">
                    <button
                        class="btn btn-secondary w-full-mobile"
                        id="exportCsv">üìÑ Exportar CSV</button
                    >
                    <button
                        class="btn btn-secondary w-full-mobile"
                        id="exportHtml">üåê Exportar HTML</button
                    >
                </div>
            </div>

            <section class="card animate-fade-in">
                <div class="filters-bar mb-4">
                    <div class="filter-group">
                        <label for="anioFilter">A√±o:</label>
                        <select id="anioFilter">
                            <option value="">Todos</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">Estado:</label>
                        <select id="statusFilter">
                            <option value="">Todos</option>
                            <option value="1">S√≥lo Activas</option>
                            <option value="0">S√≥lo Canceladas</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>ID</th>
                                <th>Total Solicitudes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr
                                ><td
                                    colspan="4"
                                    style="text-align: center; padding: 2rem;"
                                    >Cargando reporte...</td
                                ></tr
                            >
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Detalle Modal -->
            <div class="modal-overlay" id="detailModal">
                <div class="modal">
                    <div class="modal-header">
                        <h2 id="detailTitle">Detalle de Usuario</h2>
                        <button id="closeDetail" class="close-btn"
                            >&times;</button
                        >
                    </div>
                    <div class="modal-body">
                        <div id="userDetailContent">Cargando detalles...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="exportModalTitle">Exportar Reporte</h2>
                <button id="closeExportModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="exportInitialOptions">
                    <p class="mb-6">
                        Elige c√≥mo deseas recibir el reporte de solicitudes por
                        usuario:
                    </p>
                    <div class="export-options">
                        <button
                            class="btn btn-outline w-full"
                            id="btnDownloadNow"
                        >
                            üì• Descargar ahora
                        </button>
                        <button
                            class="btn btn-outline w-full"
                            id="btnSendEmail"
                        >
                            üìß Recibir por correo
                        </button>
                    </div>
                </div>

                <div id="emailFormSection" style="display: none;">
                    <p class="mb-4">
                        Ingresa el correo electr√≥nico donde recibir√°s el
                        reporte:
                    </p>
                    <div class="form-group">
                        <label for="exportEmail">Correo Electr√≥nico</label>
                        <input
                            type="email"
                            id="exportEmail"
                            placeholder="ejemplo@correo.com"
                            required
                        />
                    </div>
                    <div class="modal-footer mt-4">
                        <button class="btn btn-secondary" id="btnBackToOptions"
                            >Volver</button
                        >
                        <button class="btn btn-primary" id="btnConfirmEmail"
                            >Enviar Reporte</button
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { reportes } from "../lib/api";

    const API_BASE_URL =
        import.meta.env.PUBLIC_API_URL || "https://api-frost.onrender.com/api";
    const reportTable = document.getElementById("reportTableBody");
    const anioFilter = document.getElementById(
        "anioFilter",
    ) as HTMLSelectElement;
    const statusFilter = document.getElementById(
        "statusFilter",
    ) as HTMLSelectElement;
    const detailModal = document.getElementById("detailModal");
    const closeDetail = document.getElementById("closeDetail");

    async function loadReport() {
        if (!reportTable) return;
        reportTable.innerHTML =
            '<tr><td colspan="4" style="text-align: center;">Cargando...</td></tr>';

        try {
            const params = {
                anio: anioFilter.value,
                activo: statusFilter.value,
            };
            const response = await reportes.getPorUsuario(params);
            const data = response.data || [];

            if (data.length === 0) {
                reportTable.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 2.5rem; color: var(--text-muted); font-style: italic;">(!) No se encontraron solicitudes asignadas en el periodo.</td></tr>`;
                return;
            }

            reportTable.innerHTML = data
                .map(
                    (item: any) => `
				<tr>
					<td>
						<div class="user-cell">
							<div class="avatar-sm">${item.login.substring(0, 2).toUpperCase()}</div>
							<div class="user-info">
								<span class="user-name">${item.nombre_completo || item.login}</span>
								<span class="user-login">@${item.login}</span>
							</div>
						</div>
					</td>
					<td>${item.id_usuario}</td>
					<td><strong>${item.total_solicitudes}</strong></td>
					<td>
						<button class="btn-detail" data-id="${item.id_usuario}">Ver Detalle</button>
					</td>
				</tr>
			`,
                )
                .join("");

            document.querySelectorAll(".btn-detail").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    const id = (e.target as HTMLElement).dataset.id;
                    if (id) showDetail(id);
                });
            });
        } catch (error) {
            reportTable.innerHTML =
                '<tr><td colspan="4" style="text-align: center;">Error al generar reporte</td></tr>';
        }
    }

    async function showDetail(userId: string) {
        detailModal?.classList.add("active");
        const content = document.getElementById("userDetailContent");
        if (!content) return;
        content.innerHTML = "Cargando...";

        try {
            const params = {
                anio: anioFilter.value,
                activo: statusFilter.value,
            };
            const data = await reportes.getDetallePorUsuario(userId, params);
            const sols = data.solicitudes.data || [];

            content.innerHTML = `
				<div class="detail-summary mb-4">
					<p><strong>Usuario:</strong> ${data.usuario.nombre_completo}</p>
					<p><strong>Total en periodo:</strong> ${data.solicitudes.total}</p>
				</div>
				<table class="data-table compact">
					<thead>
						<tr>
							<th>Solicitud</th>
							<th>Fecha</th>
							<th>Estado</th>
						</tr>
					</thead>
					<tbody>
						${sols
                            .map(
                                (s: any) => `
							<tr>
								<td>#${s.id_solicitud}</td>
								<td>${new Date(s.fecha_Solicitud).toLocaleDateString()}</td>
								<td><span class="badge ${s.activo ? "badge-success" : "badge-danger"}">${s.activo ? "S√≠" : "No"}</span></td>
							</tr>
						`,
                            )
                            .join("")}
					</tbody>
				</table>
			`;
        } catch (err) {
            content.innerHTML = "Error al cargar detalles";
        }
    }

    // Export Handlers
    const exportModal = document.getElementById("exportModal");
    const closeExportModal = document.getElementById("closeExportModal");
    const exportInitialOptions = document.getElementById(
        "exportInitialOptions",
    );
    const emailFormSection = document.getElementById("emailFormSection");
    const exportEmailInput = document.getElementById(
        "exportEmail",
    ) as HTMLInputElement;

    let pendingExportType = "csv";

    function openExportModal(type: string) {
        pendingExportType = type;
        const title = document.getElementById("exportModalTitle");
        if (title)
            title.textContent = `Exportar Reporte (${type.toUpperCase()})`;

        exportInitialOptions!.style.display = "block";
        emailFormSection!.style.display = "none";
        exportModal?.classList.add("active");
    }

    document
        .getElementById("exportCsv")
        ?.addEventListener("click", () => openExportModal("csv"));
    document
        .getElementById("exportHtml")
        ?.addEventListener("click", () => openExportModal("html"));

    document.getElementById("btnDownloadNow")?.addEventListener("click", () => {
        const userId = localStorage.getItem("user_id");
        const url = `${API_BASE_URL}/reportes/solicitudes-por-usuario/export/${pendingExportType}?anio=${anioFilter.value}&activo=${statusFilter.value}&user_id=${userId}`;
        window.open(url, "_blank");
        exportModal?.classList.remove("active");
    });

    document.getElementById("btnSendEmail")?.addEventListener("click", () => {
        exportInitialOptions!.style.display = "none";
        emailFormSection!.style.display = "block";
    });

    document
        .getElementById("btnBackToOptions")
        ?.addEventListener("click", () => {
            exportInitialOptions!.style.display = "block";
            emailFormSection!.style.display = "none";
        });

    document
        .getElementById("btnConfirmEmail")
        ?.addEventListener("click", async () => {
            const email = exportEmailInput.value;
            if (!email) {
                alert("Por favor ingresa un correo electr√≥nico.");
                return;
            }

            const btn = document.getElementById(
                "btnConfirmEmail",
            ) as HTMLButtonElement;
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = "Enviando...";

                await reportes.enviarPorEmail({
                    type: pendingExportType,
                    anio: anioFilter.value,
                    activo: statusFilter.value,
                    email: email,
                });

                (window as any).showToast("Reporte enviado con √©xito");
                exportModal?.classList.remove("active");
                exportEmailInput.value = "";
            } catch (error: any) {
                console.error(error);
                (window as any).showToast(
                    error.message || "Error al enviar el reporte",
                    "error",
                );
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

    closeExportModal?.addEventListener("click", () =>
        exportModal?.classList.remove("active"),
    );

    closeDetail?.addEventListener("click", () =>
        detailModal?.classList.remove("active"),
    );
    anioFilter?.addEventListener("change", loadReport);
    statusFilter?.addEventListener("change", loadReport);

    loadReport();

    // Mobile Menu Toggle
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    menuToggle?.addEventListener("click", () => {
        sidebar?.classList.toggle("mobile-active");
    });
</script>

<style>
    .app-layout {
        display: flex;
        min-height: 100vh;
    }
    .main-content {
        flex: 1;
        padding: 2rem 3rem;
        background: var(--bg-main);
    }

    .filters-bar {
        display: flex;
        gap: 1.5rem;
        background: var(--primary-light);
        padding: 1.25rem;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .filter-group select {
        width: auto;
        border-color: var(--primary);
    }

    .user-cell {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .avatar-sm {
        width: 32px;
        height: 32px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
    }
    .user-info {
        display: flex;
        flex-direction: column;
    }
    .user-name {
        font-weight: 600;
        color: var(--text-main);
    }
    .user-login {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .btn-detail {
        background: none;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.875rem;
    }
    .btn-detail:hover {
        background: var(--primary);
        color: white;
    }

    .compact {
        font-size: 0.8125rem;
    }
    .compact th,
    .compact td {
        padding: 0.5rem;
    }

    @media (max-width: 1024px) {
        .main-content {
            padding: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }
        .filters-bar {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        .filter-group {
            justify-content: space-between;
        }
        .filter-group select {
            flex: 1;
            max-width: 200px;
        }
    }

    .export-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .btn-outline {
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 1rem;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-outline:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
    }

    .mb-6 {
        margin-bottom: 1.5rem;
    }
</style>

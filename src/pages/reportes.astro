---
import Layout from "../layouts/Layout.astro";
import Sidebar from "../components/Sidebar.astro";
---

<Layout title="Reportes">
    <div class="app-layout">
        <Sidebar active="reportes" />

        <main class="main-content">
            <header class="content-header">
                <div>
                    <h1>Reportes y Estad칤sticas</h1>
                    <p class="subtitle">
                        Carga de trabajo por usuario y exportaci칩n de datos
                    </p>
                </div>
                <div class="export-actions">
                    <button class="btn btn-secondary" id="exportCsv"
                        >游늯 Exportar CSV</button
                    >
                    <button class="btn btn-secondary" id="exportHtml"
                        >游깷 Exportar HTML</button
                    >
                </div>
            </header>

            <section class="card animate-fade-in">
                <div class="filters-bar mb-4">
                    <div class="filter-group">
                        <label for="anioFilter">A침o:</label>
                        <select id="anioFilter">
                            <option value="">Todos</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">Estado:</label>
                        <select id="statusFilter">
                            <option value="">Todos</option>
                            <option value="1">S칩lo Activas</option>
                            <option value="0">S칩lo Canceladas</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>ID</th>
                                <th>Total Solicitudes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr
                                ><td
                                    colspan="4"
                                    style="text-align: center; padding: 2rem;"
                                    >Cargando reporte...</td
                                ></tr
                            >
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Detalle Modal -->
            <div class="modal-overlay" id="detailModal">
                <div class="modal">
                    <div class="modal-header">
                        <h2 id="detailTitle">Detalle de Usuario</h2>
                        <button id="closeDetail" class="close-btn"
                            >&times;</button
                        >
                    </div>
                    <div class="modal-body">
                        <div id="userDetailContent">Cargando detalles...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</Layout>

<script>
    import { reportes } from "../lib/api";

    const API_BASE_URL =
        import.meta.env.PUBLIC_API_URL || "https://api-frost.onrender.com/api";
    const reportTable = document.getElementById("reportTableBody");
    const anioFilter = document.getElementById(
        "anioFilter",
    ) as HTMLSelectElement;
    const statusFilter = document.getElementById(
        "statusFilter",
    ) as HTMLSelectElement;
    const detailModal = document.getElementById("detailModal");
    const closeDetail = document.getElementById("closeDetail");

    async function loadReport() {
        if (!reportTable) return;
        reportTable.innerHTML =
            '<tr><td colspan="4" style="text-align: center;">Cargando...</td></tr>';

        try {
            const active = statusFilter.value;
            const anio = anioFilter.value;
            const response = await reportes.getPorUsuario();
            const data = response.data || [];

            reportTable.innerHTML = data
                .map(
                    (item: any) => `
				<tr>
					<td>
						<div class="user-cell">
							<div class="avatar-sm">${item.login.substring(0, 2).toUpperCase()}</div>
							<div class="user-info">
								<span class="user-name">${item.nombre_completo || item.login}</span>
								<span class="user-login">@${item.login}</span>
							</div>
						</div>
					</td>
					<td>${item.id_usuario}</td>
					<td><strong>${item.total_solicitudes}</strong></td>
					<td>
						<button class="btn-detail" data-id="${item.id_usuario}">Ver Detalle</button>
					</td>
				</tr>
			`,
                )
                .join("");

            document.querySelectorAll(".btn-detail").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    const id = (e.target as HTMLElement).dataset.id;
                    if (id) showDetail(id);
                });
            });
        } catch (error) {
            reportTable.innerHTML =
                '<tr><td colspan="4" style="text-align: center;">Error al generar reporte</td></tr>';
        }
    }

    async function showDetail(userId: string) {
        detailModal?.classList.add("active");
        const content = document.getElementById("userDetailContent");
        if (!content) return;
        content.innerHTML = "Cargando...";

        try {
            const data = await reportes.getDetallePorUsuario(userId);
            const sols = data.solicitudes.data || [];

            content.innerHTML = `
				<div class="detail-summary mb-4">
					<p><strong>Usuario:</strong> ${data.usuario.nombre_completo}</p>
					<p><strong>Total en periodo:</strong> ${data.solicitudes.total}</p>
				</div>
				<table class="data-table compact">
					<thead>
						<tr>
							<th>Solicitud</th>
							<th>Fecha</th>
							<th>Estado</th>
						</tr>
					</thead>
					<tbody>
						${sols
                            .map(
                                (s: any) => `
							<tr>
								<td>#${s.id_solicitud}</td>
								<td>${new Date(s.fecha_Solicitud).toLocaleDateString()}</td>
								<td><span class="badge ${s.activo ? "badge-success" : "badge-danger"}">${s.activo ? "S칤" : "No"}</span></td>
							</tr>
						`,
                            )
                            .join("")}
					</tbody>
				</table>
			`;
        } catch (err) {
            content.innerHTML = "Error al cargar detalles";
        }
    }

    // Export Handlers
    document.getElementById("exportCsv")?.addEventListener("click", () => {
        const url = `${API_BASE_URL}/reportes/solicitudes-por-usuario/export/csv?anio=${anioFilter.value}&activo=${statusFilter.value}`;
        window.open(url, "_blank");
    });

    document.getElementById("exportHtml")?.addEventListener("click", () => {
        const url = `${API_BASE_URL}/reportes/solicitudes-por-usuario/export/html?anio=${anioFilter.value}&activo=${statusFilter.value}`;
        window.open(url, "_blank");
    });

    closeDetail?.addEventListener("click", () =>
        detailModal?.classList.remove("active"),
    );
    anioFilter?.addEventListener("change", loadReport);
    statusFilter?.addEventListener("change", loadReport);

    loadReport();
</script>

<style>
    .app-layout {
        display: flex;
        min-height: 100vh;
    }
    .main-content {
        flex: 1;
        padding: 2rem 3rem;
        background: var(--bg-main);
    }
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .filters-bar {
        display: flex;
        gap: 2rem;
        background: var(--primary-light);
        padding: 1rem;
        border-radius: var(--radius);
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .filter-group select {
        width: auto;
        border-color: var(--primary);
    }

    .user-cell {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .avatar-sm {
        width: 32px;
        height: 32px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
    }
    .user-info {
        display: flex;
        flex-direction: column;
    }
    .user-name {
        font-weight: 600;
        color: var(--text-main);
    }
    .user-login {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .btn-detail {
        background: none;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 0.875rem;
    }
    .btn-detail:hover {
        background: var(--primary);
        color: white;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
        z-index: 1000;
    }
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .modal {
        background: white;
        padding: 2rem;
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 1rem;
    }
    .close-btn {
        font-size: 1.5rem;
        color: var(--text-muted);
    }

    .compact {
        font-size: 0.8125rem;
    }
    .compact th,
    .compact td {
        padding: 0.5rem;
    }

    @media (max-width: 768px) {
        .filters-bar {
            flex-direction: column;
            gap: 1rem;
        }
        .export-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>

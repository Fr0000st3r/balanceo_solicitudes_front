---
import Layout from "../layouts/Layout.astro";
import Sidebar from "../components/Sidebar.astro";
import UserBadge from "../components/UserBadge.astro";
---

<Layout title="Configuración">
    <div class="app-layout">
        <Sidebar active="configuración" />

        <main class="main-content">
            <header class="page-header">
                <div class="header-title-row">
                    <div class="header-title-left">
                        <button class="mobile-menu-toggle" id="menuToggle"
                            >☰</button
                        >
                        <h1>Configuración de Carga</h1>
                    </div>
                    <UserBadge />
                </div>
                <p class="header-subtitle hide-mobile">
                    Ajusta las reglas de balanceo y distribución de trabajo
                </p>
            </header>

            <div class="page-actions-row">
                <button class="btn btn-primary w-full-mobile" id="newConfigBtn">
                    + Nueva Regla
                </button>
            </div>

            <div class="config-grid animate-fade-in">
                <section class="card">
                    <h2>Reglas Activas</h2>
                    <div class="table-responsive mt-4">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Año</th>
                                    <th>Proporción</th>
                                    <th>Diferencia</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="configTableBody">
                                <tr
                                    ><td
                                        colspan="4"
                                        style="text-align: center; padding: 2rem;"
                                        >Cargando...</td
                                    ></tr
                                >
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="card info-card">
                    <h2>Información de Balanceo</h2>
                    <p>
                        El sistema utiliza estas reglas para determinar cómo se
                        asignan las nuevas solicitudes entre los usuarios
                        activos.
                    </p>
                    <ul class="info-list mt-4">
                        <li>
                            <strong>Proporción (Batching):</strong> Determina cuántas
                            solicitudes se asignan seguidas a un usuario (Round Robin).
                            Por ejemplo, si es 5, el Usuario A recibirá 5 solicitudes
                            antes de pasar el turno al Usuario B.
                        </li>
                        <li>
                            <strong>Diferencia (Seguridad):</strong> Es el límite
                            de tolerancia. Si el usuario en turno supera al de menos
                            carga por más de este valor, el sistema rompe el turno
                            y asigna al que tiene menos trabajo para equilibrar.
                        </li>
                        <li>
                            <strong>Fallback:</strong> Si no hay una configuración
                            activa para el año actual, el sistema utiliza automáticamente
                            la <em>Carga Mínima Absoluta</em> para garantizar la asignación.
                        </li>
                    </ul>
                </section>
            </div>

            <!-- Modal New Config -->
            <div class="modal-overlay" id="configModal">
                <div class="modal">
                    <div class="modal-header">
                        <h2>Nueva Regla de Carga</h2>
                        <button id="closeModal" class="close-btn"
                            >&times;</button
                        >
                    </div>
                    <form id="configForm" class="modal-body">
                        <div class="form-group">
                            <label for="anio">Año</label>
                            <input
                                type="number"
                                id="anio"
                                name="anio"
                                value="2026"
                                required
                            />
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="proporcion">Proporción</label>
                                <input
                                    type="number"
                                    id="proporcion"
                                    name="proporcion"
                                    value="1"
                                    min="1"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="diferencia">Diferencia Máxima</label
                                >
                                <input
                                    type="number"
                                    id="diferencia"
                                    name="diferencia"
                                    value="0"
                                    min="0"
                                    required
                                />
                            </div>
                        </div>
                        <div class="modal-footer mt-4">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                id="cancelBtn">Cancelar</button
                            >
                            <button type="submit" class="btn btn-primary"
                                >Crear Regla</button
                            >
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</Layout>

<script>
    import { configuracion } from "../lib/api";

    const tableBody = document.getElementById("configTableBody");
    const modal = document.getElementById("configModal");
    const form = document.getElementById("configForm") as HTMLFormElement;

    async function loadConfigs() {
        if (!tableBody) return;
        try {
            const res = await configuracion.getAll();
            const data = res.data || (Array.isArray(res) ? res : []);

            if (data.length === 0) {
                tableBody.innerHTML =
                    '<tr><td colspan="4" style="text-align: center; padding: 2.5rem; color: var(--text-muted); font-style: italic;">(!) No hay reglas configuradas.</td></tr>';
                return;
            }

            tableBody.innerHTML = data
                .map(
                    (c: any) => `
				<tr>
					<td><strong>${c.anio}</strong></td>
					<td>${c.proporcion} solicitudes</td>
					<td>±${c.diferencia} de margen</td>
					<td>
						<span class="badge ${c.activo ? "badge-success" : "badge-danger"}">
							${c.activo ? "Activa" : "Inactiva"}
						</span>
					</td>
				</tr>
			`,
                )
                .join("");
        } catch (err) {
            console.error(err);
            tableBody.innerHTML =
                '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--danger);">⚠️ Error al conectar con el servidor</td></tr>';
        }
    }

    document
        .getElementById("newConfigBtn")
        ?.addEventListener("click", () => modal?.classList.add("active"));
    document
        .getElementById("closeModal")
        ?.addEventListener("click", () => modal?.classList.remove("active"));
    document
        .getElementById("cancelBtn")
        ?.addEventListener("click", () => modal?.classList.remove("active"));

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const submitBtn = form.querySelector(
            'button[type="submit"]',
        ) as HTMLButtonElement;

        try {
            submitBtn.disabled = true;
            await configuracion.create(data);
            (window as any).showToast("Regla creada correctamente");
            modal?.classList.remove("active");
            form.reset();
            loadConfigs();
        } catch (err: any) {
            (window as any).showToast(
                err.message || "Error al crear la regla",
                "error",
            );
        } finally {
            submitBtn.disabled = false;
        }
    });

    loadConfigs();

    // Mobile Menu Toggle
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    menuToggle?.addEventListener("click", () => {
        sidebar?.classList.toggle("mobile-active");
    });
</script>

<style>
    .app-layout {
        display: flex;
        min-height: 100vh;
    }
    .main-content {
        flex: 1;
        padding: 2rem 3rem;
        background: var(--bg-main);
        min-width: 0;
    }

    .config-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        width: 100%;
    }

    .config-grid > * {
        min-width: 0;
    }

    .info-card {
        background: var(--primary-light);
        border-color: var(--primary);
        height: min-content;
    }

    .info-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .info-list li {
        position: relative;
        padding-left: 1.5rem;
        font-size: 0.875rem;
        line-height: 1.6;
    }

    .info-list li::before {
        content: "→";
        position: absolute;
        left: 0;
        color: var(--primary);
        font-weight: bold;
    }

    /* Standard responsive behavior */
    @media (max-width: 1024px) {
        .main-content {
            padding: 1.5rem;
        }
        .config-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }
    }

    @media (max-width: 480px) {
        .card {
            padding: 1rem !important;
        }
    }
</style>
